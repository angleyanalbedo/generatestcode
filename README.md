# Industrial-ST-Distiller ğŸš€

**Industrial-ST-Distiller** æ˜¯ä¸€ä¸ªä¸“ä¸ºå·¥ä¸šè‡ªåŠ¨åŒ–é¢†åŸŸè®¾è®¡çš„åˆæˆæ•°æ®ç”Ÿæˆä¸è’¸é¦æ¡†æ¶ã€‚å®ƒåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„é«˜çº§æ¨ç†èƒ½åŠ›ï¼Œè‡ªåŠ¨åŒ–åœ°ç”Ÿæˆã€è¿›åŒ–å¹¶æ ¡éªŒ IEC 61131-3 æ ‡å‡†ä¸‹çš„ **ç»“æ„åŒ–æ–‡æœ¬ (ST)** ä»£ç ã€‚

æœ¬é¡¹ç›®çš„æ ¸å¿ƒç›®æ ‡æ˜¯æ„å»ºé«˜è´¨é‡çš„ SFTï¼ˆæœ‰ç›‘ç£å¾®è°ƒï¼‰å’Œ DPOï¼ˆåå¥½ä¼˜åŒ–ï¼‰æ•°æ®é›†ï¼Œç”¨äºè®­ç»ƒæ›´æ‡‚å·¥ä¸šæ§åˆ¶é€»è¾‘çš„å°å‹åŒ–ã€å‚ç›´åŒ–æ¨¡å‹ã€‚

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

* **å¼‚æ­¥åç¨‹é©±åŠ¨**ï¼šåŸºäº `asyncio` å’Œ `Semaphore` é™åˆ¶ï¼Œå®ç°æè‡´çš„å¹¶è¡Œæ¨ç†æ€§èƒ½ï¼Œå®Œç¾å‹æ¦¨ vLLM æ¨ç†åç«¯ã€‚
* **ç»„ä»¶åŒ–æ¶æ„**ï¼šéµå¾ªâ€œç»„åˆä¼˜äºç»§æ‰¿â€åŸåˆ™ï¼Œå°†è°ƒåº¦ã€å­˜å‚¨ä¸æç¤ºè¯ç­–ç•¥å½»åº•è§£è€¦ã€‚
* **Evol-Instruct ç­–ç•¥**ï¼šå†…ç½®ä»»åŠ¡è¿›åŒ–æœºåˆ¶ï¼Œè‡ªåŠ¨å°†ç®€å•çš„æŒ‡ä»¤è½¬åŒ–ä¸ºå¤æ‚çš„å·¥ä¸šåœºæ™¯éœ€æ±‚ã€‚
* **é­”é¬¼çº§è¯­æ³•æ ¡éªŒ**ï¼š
* **å®æ—¶æ ¡éªŒ**ï¼šåˆ©ç”¨æ­£åˆ™è¿›è¡Œåˆæ­¥ç»“æ„æ‹¦æˆªã€‚
* **æ·±åº¦è´¨æ£€ (Lark)**ï¼šåŸºäº `Lark` åº“æ„å»º ST Parserï¼Œå®ç°å˜é‡å®šä¹‰åŸŸæ£€æŸ¥ä¸åµŒå¥—é—­åˆæ ¡éªŒã€‚


* **è‡ªåŠ¨ DPO æ„é€ **ï¼šé€šè¿‡æ•è·æ¨¡å‹åœ¨è‡ªæˆ‘ä¿®æ­£è¿‡ç¨‹ä¸­çš„å¤±è´¥æ ·æœ¬ï¼Œè‡ªåŠ¨é…å¯¹ç”Ÿæˆ `Chosen/Rejected` æ•°æ®ã€‚
* ### ğŸ’¡ æ ¸å¿ƒè®¾è®¡æ€æƒ³çš„è½¬å˜ 


> **Validation vs. Manipulation (æ ¡éªŒä¸æ“ä½œè§£è€¦)**ï¼š
> æˆ‘ä»¬å½»åº•å‰¥ç¦»äº†â€œä»£ç æ ¡éªŒâ€ä¸â€œä»£ç æ“ä½œâ€çš„èŒè´£ã€‚Lark AST (`STParser`) ä¸å†ç”¨äºä¸¥è‹›çš„å¯¹é”™åˆ¤å®šï¼ˆå› ä¸ºå®¹æ˜“æ¼åˆ¤æˆ–è¯¯æ€ï¼‰ï¼Œè€Œæ˜¯ä¸“æ³¨äºå®ƒæœ€æ“…é•¿çš„ä»£ç é‡æ„ä¸ä¾èµ–åˆ†æï¼›çœŸä¼ªçš„åˆ¤å®šæƒåˆ™å…¨éƒ¨äº¤è¿˜ç»™çœŸæ­£çš„å·¥ä¸šç¼–è¯‘å™¨ (`MatiecValidator`)ã€‚


---

## ğŸ—ï¸ è½¯ä»¶æ¶æ„

### æ›´æ–°åçš„æ ¸å¿ƒæ¶æ„ç»„ä»¶ (Architecture Components)

* **ConfigManager**: ç»Ÿä¸€ç®¡ç† YAML é…ç½®ã€æ¨¡å‹å‚æ•°ä¸æ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒå¤šåç«¯çš„åŠ¨æ€è·¯ç”±ã€‚
* **PromptManager**: è´Ÿè´£ Jinja2 æ¨¡æ¿æ¸²æŸ“ï¼Œå®ç°æç¤ºè¯ç‰ˆæœ¬åŒ–ç®¡ç†ä¸ Few-shot åŠ¨æ€ç»„è£…ã€‚
* **IOHandler**: å¤„ç†å¼‚æ­¥æ–‡ä»¶å†™å…¥ã€å†…å­˜å»é‡ç´¢å¼•ï¼Œå¹¶ä¸¥æ ¼åŒºåˆ†**ä¸šåŠ¡é€»è¾‘å¤±è´¥ (DataOps/DPO è´Ÿæ ·æœ¬æŒ–æ˜)** ä¸**ç³»ç»Ÿè¿è¡Œå¼‚å¸¸ (DevOps ç›‘æ§)**ï¼Œå®ç°æ•°æ®çš„é¢—ç²’åº¦å½’æ¡£ã€‚
* **STValidator (åŒæ¼æ–—æ ¡éªŒå¼•æ“)**: æ•°æ®è´¨é‡çš„ç»ˆæå®ˆé—¨å‘˜ã€‚
* **FastValidator**: æä¾›æé€Ÿçš„å¯å‘å¼æ­£åˆ™ä¸ç»“æ„å¯¹é½æ£€æŸ¥ï¼Œç§’çº§æ‹¦æˆªæ®‹ç¼ºä»£ç ã€‚
* **MatiecValidator**: æ·±åº¦é›†æˆ OpenPLC (`iec2c`) å·¥ä¸šçº§ C++ ç¼–è¯‘å™¨ï¼Œæ‰§è¡Œä¸¥æ ¼çš„ä½œç”¨åŸŸä¸ç±»å‹æ¨å¯¼æ£€æŸ¥ï¼Œç¡®ä¿æ”¾è¡Œçš„ä»£ç  100% ç‰©ç†å¯ç”¨ï¼Œå¹¶è¾“å‡ºçœŸå®ç¼–è¯‘å™¨æŠ¥é”™ç”¨äº RL/DPO è®­ç»ƒã€‚
* **STParser (AST æ“ä½œå¼•æ“)**: åŸºäº Lark æ„å»ºçš„åº•å±‚è¯­æ³•æ ‘åˆ†æå™¨ã€‚ç°å·²ä¸“èŒè´Ÿè´£ä»£ç çš„è§£æ„ä¸é‡ç»„ï¼ŒåŒ…å«æ•°æ®ä¾èµ–åˆ†æ (`STSlicer` æ ¸å¿ƒé€»è¾‘åˆ‡ç‰‡) ä¸æ— æŸæ•°æ®å¢å¼º (`STRewriter` ä¹±åºé‡å†™)ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
uv sync

```

### 2. é…ç½® `config.yaml`

```yaml
generation:
  model: "industrial-coder"
  base_url: "http://localhost:8000/v1"
  max_concurrency: 100
  max_retries: 3

file_paths:
  output_file: "data/st_sft.jsonl"
  dpo_file: "data/st_dpo.jsonl"
  history_file: "data/history.jsonl"
  golden_file: "config/golden_memory.json"

```

### 3. è¿è¡Œå¼•æ“

```python
import asyncio
from src.distillation.distillation_engine import AsyncSTDistillationEngine
from prompt_manager import PromptManager
from config_manager import ConfigManager
import platform

if __name__ == "__main__":
    # Windows å¹³å°éœ€è¦è®¾ç½® EventLoop ç­–ç•¥
    if platform.system() == 'Windows':
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
    config = ConfigManager()
    prompt_manager = PromptManager('prompts.yaml')
    engine = AsyncSTDistillationEngine(config, prompt_manager)
    asyncio.run(engine.run())

```

---

## ğŸ› ï¸ æ•°æ®ç”Ÿæˆæµæ°´çº¿

1. **Brainstorm**: æ ¹æ®å·¥ä¸šé¢†åŸŸæ„æ€åˆå§‹ä»»åŠ¡ã€‚
2. **Evolve**: å¢åŠ çº¦æŸï¼ˆå¦‚ï¼šä¿¡å·æŠ–åŠ¨ã€é”™è¯¯æ¢å¤ï¼‰è¿›åŒ–ä»»åŠ¡ã€‚
3. **Generate**: ç»“åˆ Golden Memory ç”Ÿæˆä»£ç ã€‚
4. **Validate**: è¯­æ³•æ ¡éªŒå¤±è´¥è®°å½•ä¸º **Rejected**ï¼ŒæˆåŠŸè®°å½•ä¸º **Chosen**ã€‚

---

## ğŸ“… TODO / è·¯çº¿å›¾

é¡¹ç›®æ­£å¤„äºé«˜é€Ÿè¿­ä»£ä¸­ï¼Œä»¥ä¸‹åŠŸèƒ½æ­£åœ¨å¼€å‘ï¼š

* [x] **STRewriter (ä»£ç é‡æ„å™¨)**ï¼šåŸºäº Lark AST å®ç°ä»£ç å˜æ¢ï¼ˆå¦‚ IF è½¬ CASEã€å˜é‡æ··æ·†ï¼‰ï¼Œå®ç°æ•°æ®é‡çš„æŒ‡æ•°çº§å¢å¼ºã€‚
* [ ] **STSlicer (ä»£ç åˆ‡ç‰‡å™¨)**ï¼šå®ç°åŸºäºæ•°æ®æµçš„ç¨‹åºåˆ‡ç‰‡ï¼Œç”¨äºæå–å…³é”®é€»è¾‘ç‰‡æ®µï¼Œæå‡æ¨¡å‹å¯¹é•¿ä»£ç çš„ç†è§£åŠ›ã€‚
* [x] **Semantic Analyzer**: å¢åŠ æ›´ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ä¸æœªå®šä¹‰å˜é‡æ‰«æã€‚
* [x] **MatIEC Support**: å¢åŠ MatIECä½œä¸ºç¼–è¯‘å™¨æ£€æŸ¥ã€‚
* [x] **Multi-Backend Support**: å¢åŠ å¯¹ Hugging Face TGI å’Œæœ¬åœ° Llama.cpp çš„åŸç”Ÿæ”¯æŒã€‚

---

## ğŸ“ˆ æ•°æ®é›†æ ¼å¼

### SFT æ•°æ®

```json
{
  "instruction": "Write an ST function block for...",
  "output": "FUNCTION_BLOCK ...",
  "metadata": {"thought": "...", "evolution": "evolved"}
}

```

### DPO æ•°æ®

```json
{
  "prompt": "Write ST code for: ...",
  "chosen": "FUNCTION_BLOCK ... (Correct)",
  "rejected": "FUNCTION_BLOCK ... (Error)",
  "metadata": {"error": "Missing END_VAR"}
}

```
## ğŸ§° å·¥å…·é“¾ (Toolchain)

`tools/` ç›®å½•åŒ…å«äº†ä¸€ç³»åˆ—ç”¨äºæ•°æ®æ¸…æ´—ã€æ ¼å¼æ ¡éªŒå’Œæ¨¡å‹å¾®è°ƒå‡†å¤‡çš„å·¥ç¨‹åŒ–è„šæœ¬ã€‚

| å·¥å…·åç§° | æ ¸å¿ƒåŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
| :--- | :--- | :--- |
| **`clean_st_matiec.py`** | **[æ ¸å¿ƒ]** åŸºäº Matiec ç¼–è¯‘å™¨çš„å·¥ä¸šçº§åŒæ¼æ–—æ•°æ®æ¸…æ´—å·¥å…·ã€‚ | ç¦»çº¿å¤„ç†çˆ¬å–çš„ ST æ•°æ®é›†ã€‚å°†æ•°æ®æŒ‰è´¨é‡åˆ†æµä¸º `golden` (SFT çº§) å’Œ `matiec_error` (DPO è´Ÿæ ·æœ¬çº§)ã€‚ |
| **`check_json_schema.py`** | å¿«é€Ÿæ‰«æ `.jsonl` / `.json` æ•°æ®é›†ï¼Œæ ¡éªŒå­—æ®µå®Œæ•´æ€§ï¼ˆInstruction/Output ç­‰ï¼‰ã€‚ | æ•°æ®é›†å…¥åº“å‰çš„å€¼å®ˆæ ¡éªŒã€‚ |
| **`fix_json_schema.py`** | è‡ªåŠ¨å°è¯•ä¿®å¤å›  LLM æˆªæ–­æˆ–è½¬ä¹‰é”™è¯¯å¯¼è‡´çš„ JSON ç»“æ„æŸåã€‚ | æŠ¢æ•‘å¤§æ‰¹é‡ç”Ÿæˆä»»åŠ¡ä¸­çš„æŸåæ•°æ®ã€‚ |
| **`convert_deepseek_format.py`** | å°†æ ‡å‡†åŒ– ST æ•°æ®é›†è½¬æ¢ä¸º DeepSeek / LLaMA ç­‰ä¸»æµå¤§æ¨¡å‹çš„å¾®è°ƒï¼ˆSFTï¼‰æŒ‡ä»¤æ ¼å¼ã€‚ | æ¨¡å‹è®­ç»ƒå‰çš„æ•°æ®æ ¼å¼å‡†å¤‡ã€‚ |

> **âš ï¸ æ³¨æ„ (å…³äº Matiec ç¼–è¯‘å™¨)**: 
> è¿è¡Œ `clean_st_matiec.py` å¼ºä¾èµ– OpenPLC çš„ `iec2c` ç¼–è¯‘å™¨ã€‚è¯·ç¡®ä¿å·²å°† `iec2c.exe` åŠå…¶é…å¥—çš„ `lib/` æ ‡å‡†åº“æ–‡ä»¶å¤¹æ”¾ç½®åœ¨æ­£ç¡®è·¯å¾„ï¼Œæˆ–é€šè¿‡ `-I` å‚æ•°æŒ‡å®šåº“ä½ç½®ã€‚
---

## ğŸ“„ å¼€æºåè®®

[MIT License](https://www.google.com/search?q=MIT+License+text)

`src/stparser` ä¸­çš„`anltr`å®ç°çš„ä»£ç æ¥è‡ªäº[ST_Slicing](https://github.com/oneqiao/ST_Slicing)

---

